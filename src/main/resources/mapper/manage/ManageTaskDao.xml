<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.modules.manage.dao.ManageTaskDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.renren.modules.manage.entity.ManageTaskEntity" id="manageTaskMap">
        <result property="taskId" column="task_id"/>
        <result property="projectId" column="project_id"/>
        <result property="taskName" column="task_name"/>
        <result property="status" column="status"/>
        <result property="assigneeId" column="assignee_id"/>
        <result property="completeUserId" column="complete_user_id"/>
        <result property="estimate" column="estimate"/>
        <result property="endDate" column="end_date"/>
        <result property="relatedTaskId" column="related_task_id"/>
        <result property="beginDate" column="begin_date"/>
        <result property="realBeginDate" column="real_begin_date"/>
        <result property="finishDate" column="finish_date"/>
        <result property="taskType" column="task_type"/>
        <result property="comment" column="comment"/>
        <result property="createUserId" column="create_user_id"/>
        <result property="createTime" column="create_time"/>
        <collection property="projectName" column="{projectId=project_id}" select="getProjectName"/>
        <collection property="assignName" column="{userId=assignee_id}" select="getUserName"/>
        <collection property="completeName" column="{userId=complete_user_id}" select="getUserName"/>
        <collection property="relatedTaskName" column="{taskId=related_task_id}" select="getTaskName"/>
        <collection property="createUserName" select="getUserName" column="{userId=create_user_id}"/>
        <collection property="usedTime" column="{taskId=task_id}" select="getUsedTime"/>
    </resultMap>
    <resultMap id="manageTaskRecordMap" type="io.renren.modules.manage.entity.ManageTaskRecordEntity">
        <id property="recordId" column="record_id"/>
        <result property="taskId" column="task_id"/>
        <result property="createUserId" column="create_user_id"/>
        <result property="createTime" column="create_time"/>
        <result property="consume" column="consume"/>
        <result property="remain" column="remain"/>
        <result property="remark" column="remark"/>
        <result property="recordDate" column="record_date"/>
        <collection property="createUserName" select="getUserName" column="{userId=create_user_id}"/>
    </resultMap>
    <select id="getRequirements" resultMap="manageTaskMap">
        select *
        from manage_task
        where task_type = 0
    </select>
    <select id="getList" resultMap="manageTaskMap">
        select * from manage_task
        <where>
            <if test="params.projectId != null and params.projectId != ''">
                and project_id = #{params.projectId}
            </if>
            <if test="params.option != null and params.option == 0 and userId != null">
                and assignee_id = #{userId}
            </if>
            <if test="params.option != null and params.option == 1 and userId != null">
                and create_user_id = #{userId}
            </if>
            <if test="params.option != null and params.option == 2 and userId != null">
                and complete_user_id = #{userId}
            </if>
        </where>
    </select>
    <select id="getProjectName" resultType="string">
        select project_name
        from manage_project
        where project_id = #{projectId}
    </select>
    <select id="getTaskName" resultType="string">
        select task_name
        from manage_task
        where task_id = #{taskId}
    </select>
    <select id="getUserName" resultType="string">
        select chinese_name
        from sys_user
        where user_id = #{userId}
    </select>
    <select id="getUsedTime" resultType="double">
        select IFNULL(datanum.consume, 0) from (select sum(consume) as consume
        from manage_task_record
        where task_id = #{taskId}) as datanum
    </select>
    <select id="worktime" resultMap="manageTaskRecordMap">
        select * from manage_task_record where task_id = #{taskId}
    </select>
</mapper>
